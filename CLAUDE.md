# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a NixOS configuration repository with integrated Home Manager that manages system and user configurations for both desktop and laptop setups. The system uses Hyprland as the window manager with a complete Wayland-based desktop environment.

## Common Development Commands

### System Configuration
```bash
# Rebuild and switch to new NixOS configuration (desktop)
sudo nixos-rebuild switch --flake .#desktop

# Rebuild and switch to new NixOS configuration (laptop)
sudo nixos-rebuild switch --flake .#laptop

# Test configuration without switching
sudo nixos-rebuild test --flake .#desktop
sudo nixos-rebuild test --flake .#laptop

# Build configuration without switching
sudo nixos-rebuild build --flake .#desktop
sudo nixos-rebuild build --flake .#laptop
```

### Home Manager (when used standalone)
```bash
# Switch to new Home Manager configuration
home-manager switch --flake .#"william@desktop"
home-manager switch --flake .#"william@laptop"

# Build Home Manager configuration
home-manager build --flake .#"william@desktop"
home-manager build --flake .#"william@laptop"
```

### Flake Operations
```bash
# Update flake inputs
nix flake update

# Show flake info
nix flake show

# Check flake for issues
nix flake check

# Lock specific input
nix flake lock --update-input nixpkgs
```

## Architecture Overview

### Configuration Structure
- **flake.nix**: Main flake configuration defining inputs and outputs for both desktop and laptop
- **system/**: Contains NixOS system configurations
  - `desktop-configuration.nix`: Desktop system configuration
  - `laptop-configuration.nix`: Laptop system configuration (includes TLP power management)
  - `*-hardware-configuration.nix`: Hardware-specific configurations
- **home-manager/**: User-level configurations
  - `desktop.nix`: Desktop home configuration
  - `laptop.nix`: Laptop home configuration (includes additional dev tools)
- **modules/shared/**: Reusable configuration modules for applications

### Key Components
- **Window Manager**: Hyprland with Wayland
- **Terminal**: Kitty
- **Shell**: Zsh
- **Application Launcher**: Rofi
- **Status Bar**: Waybar
- **Notifications**: Dunst
- **Editor**: Vim/Nixvim configuration
- **Browser**: Chromium (ungoogled-chromium)
- **Lock Screen**: Hyprlock
- **Wallpaper**: Hyprpaper

### Shared Modules
All application configurations are modularized in `modules/shared/` and imported by both desktop and laptop configurations:
- `chromium.nix`: Browser configuration
- `dunst.nix`: Notification daemon
- `git.nix`: Git configuration
- `hyperland.nix`: Hyprland window manager
- `hyprlock.nix`: Screen lock configuration
- `kitty.nix`: Terminal emulator
- `rofi.nix`: Application launcher
- `vim.nix`: Vim/Nixvim configuration
- `waybar.nix`: Status bar
- `zsh.nix`: Shell configuration
- `node.nix`: Node.js configuration (laptop only)

### Configuration Differences
- **Desktop**: Gaming-focused with Steam, more media packages
- **Laptop**: Development-focused with MariaDB, MongoDB Compass, additional dev tools, and power management via TLP

### System Features
- **Audio**: PipeWire with ALSA, PulseAudio, and JACK support
- **Bluetooth**: Experimental BluZ5 with advanced codec support
- **Virtualization**: Docker enabled
- **Security**: RTKit enabled, custom PAM limits (laptop)
- **Display**: Wayland with proper environment variables for app compatibility

## File Organization Patterns

When making changes:
1. **System-level changes**: Edit files in `system/`
2. **User-level changes**: Edit files in `home-manager/`
3. **Application-specific changes**: Edit corresponding module in `modules/shared/`
4. **New applications**: Create new module in `modules/shared/` and import in home-manager configs
5. **Hardware changes**: Edit hardware-configuration.nix files (generated by nixos-generate-config)

## Development Workflow

1. Make configuration changes
2. Test with `nixos-rebuild test` or `home-manager build`
3. If successful, apply with `nixos-rebuild switch` or `home-manager switch`
4. For system-wide changes, use `sudo nixos-rebuild switch --flake .#desktop` or `sudo nixos-rebuild switch --flake .#laptop`

## Important Notes

- Both configurations use `stateVersion = "24.05"`
- Unfree packages are allowed via `nixpkgs.config.allowUnfree = true`
- The user "william" has sudo privileges and is in docker, audio, video, and other relevant groups
- Home Manager is integrated into the NixOS configuration but can also be used standalone
- The system uses Swedish keyboard layout and Stockholm timezone with mixed US/Swedish locale settings